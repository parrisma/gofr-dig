#!/bin/bash
# =============================================================================
# GOFR-DIG Centralized Configuration
# =============================================================================
# This is the SINGLE source of truth for all port, host, and network settings.
# Source this file in all scripts:
#   source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/gofr-dig.env"
#
# Environment Modes:
#   GOFR_DIG_ENV=PROD  => uses $GOFR_DIG_ROOT/data
#   GOFR_DIG_ENV=TEST  => uses $GOFR_DIG_ROOT/test/data (default)
# =============================================================================

# -----------------------------------------------------------------------------
# Project Root Directory
# -----------------------------------------------------------------------------
if [ -z "${GOFR_DIG_ROOT:-}" ]; then
    # Try to get from BASH_SOURCE first (when directly sourced)
    if [ -n "${BASH_SOURCE[0]:-}" ] 2>/dev/null; then
        GOFR_DIG_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
    elif [ -n "${PROJECT_ROOT:-}" ]; then
        # Use PROJECT_ROOT if set by caller (run_tests.sh sets this)
        GOFR_DIG_ROOT="${PROJECT_ROOT}"
    else
        # Fallback to current directory
        GOFR_DIG_ROOT="$(cd "." && pwd)"
    fi
fi
export GOFR_DIG_ROOT

# -----------------------------------------------------------------------------
# Environment Mode (PROD or TEST)
# -----------------------------------------------------------------------------
export GOFR_DIG_ENV="${GOFR_DIG_ENV:-TEST}"

# -----------------------------------------------------------------------------
# Network Configuration
# -----------------------------------------------------------------------------
# Default host binds to all interfaces (0.0.0.0) for container deployment
export GOFR_DIG_HOST="${GOFR_DIG_HOST:-0.0.0.0}"

# Docker network name (PROD=gofr-net, TEST/DEV=gofr-test-net)
if [ "$GOFR_DIG_ENV" = "PROD" ]; then
    export GOFR_DIG_NETWORK="${GOFR_DIG_NETWORK:-gofr-net}"
else
    export GOFR_DIG_NETWORK="${GOFR_DIG_NETWORK:-gofr-test-net}"
fi

# Container name (for inter-container communication)
export GOFR_DIG_CONTAINER="${GOFR_DIG_CONTAINER:-gofr-dig_dev}"

# -----------------------------------------------------------------------------
# Server Ports
# -----------------------------------------------------------------------------
# Sourced from gofr_ports.env (single source of truth for all GOFR projects).
# The centralized env file must be sourced BEFORE this file, or its vars must
# already be exported (run_tests.sh, start-prod.sh, start-test-env.sh all do this).
_PORTS_ENV="${GOFR_DIG_ROOT}/lib/gofr-common/config/gofr_ports.env"
if [ -f "${_PORTS_ENV}" ]; then
    # shellcheck source=/dev/null
    source "${_PORTS_ENV}"
fi
unset _PORTS_ENV

export GOFR_DIG_MCP_PORT="${GOFR_DIG_MCP_PORT:?GOFR_DIG_MCP_PORT not set — source gofr_ports.env}"
export GOFR_DIG_MCPO_PORT="${GOFR_DIG_MCPO_PORT:?GOFR_DIG_MCPO_PORT not set — source gofr_ports.env}"
export GOFR_DIG_WEB_PORT="${GOFR_DIG_WEB_PORT:?GOFR_DIG_WEB_PORT not set — source gofr_ports.env}"

# -----------------------------------------------------------------------------
# Server Hosts (for binding)
# -----------------------------------------------------------------------------
# These can be overridden individually if needed
export GOFR_DIG_MCP_HOST="${GOFR_DIG_MCP_HOST:-$GOFR_DIG_HOST}"
export GOFR_DIG_MCPO_HOST="${GOFR_DIG_MCPO_HOST:-$GOFR_DIG_HOST}"
export GOFR_DIG_WEB_HOST="${GOFR_DIG_WEB_HOST:-$GOFR_DIG_HOST}"

# -----------------------------------------------------------------------------
# Core Directories
# -----------------------------------------------------------------------------
export GOFR_DIG_LOGS="${GOFR_DIG_LOGS:-$GOFR_DIG_ROOT/logs}"

# Select data directory based on environment
if [ "$GOFR_DIG_ENV" = "PROD" ]; then
    export GOFR_DIG_DATA="${GOFR_DIG_DATA:-$GOFR_DIG_ROOT/data}"
else
    export GOFR_DIG_DATA="${GOFR_DIG_DATA:-$GOFR_DIG_ROOT/test/data}"
fi

# Data subdirectories
export GOFR_DIG_STORAGE="${GOFR_DIG_STORAGE:-$GOFR_DIG_DATA/storage}"

# Token store (always in logs directory)
export GOFR_DIG_TOKEN_STORE="${GOFR_DIG_TOKEN_STORE:-$GOFR_DIG_LOGS/gofr_dig_tokens.json}"

# -----------------------------------------------------------------------------
# Docker Volume Configuration
# -----------------------------------------------------------------------------
export GOFR_DIG_DATA_VOLUME="${GOFR_DIG_DATA_VOLUME:-gofr-dig_data_dev}"

# -----------------------------------------------------------------------------
# Create Required Directories
# -----------------------------------------------------------------------------
mkdir -p "$GOFR_DIG_LOGS" 2>/dev/null || true
mkdir -p "$GOFR_DIG_STORAGE" 2>/dev/null || true

# -----------------------------------------------------------------------------
# Debug Output (only if GOFR_DIG_DEBUG is set)
# -----------------------------------------------------------------------------
if [ "${GOFR_DIG_DEBUG:-}" = "1" ]; then
    echo "GOFR-DIG Configuration:"
    echo "  ROOT:       $GOFR_DIG_ROOT"
    echo "  ENV:        $GOFR_DIG_ENV"
    echo "  DATA:       $GOFR_DIG_DATA"
    echo "  LOGS:       $GOFR_DIG_LOGS"
    echo "  NETWORK:    $GOFR_DIG_NETWORK"
    echo "  HOST:       $GOFR_DIG_HOST"
    echo "  MCP:        $GOFR_DIG_MCP_HOST:$GOFR_DIG_MCP_PORT"
    echo "  MCPO:       $GOFR_DIG_MCPO_HOST:$GOFR_DIG_MCPO_PORT"
    echo "  WEB:        $GOFR_DIG_WEB_HOST:$GOFR_DIG_WEB_PORT"
fi

