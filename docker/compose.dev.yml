# GOFR-DIG Docker Compose - Test / Dev Stack (Ephemeral)
#
# Port Configuration:
#   All ports defined in lib/gofr-common/config/gofr_ports.env
#   Test ports (prod + 100) — see lib/gofr-common/config/gofr_ports.env
#   Containers run internally on prod ports
#
# Usage:
#   cd docker
#   docker compose -f compose.dev.yml up -d       # Start all services
#   docker compose -f compose.dev.yml logs -f      # Follow logs
#   docker compose -f compose.dev.yml down          # Stop and remove
#
# Services (Ephemeral — no persistent volumes):
#   - mcp:   MCP Server (Streamable HTTP)  — host port ${GOFR_DIG_MCP_PORT_TEST}
#   - mcpo:  MCPO Server (OpenAPI wrapper) — host port ${GOFR_DIG_MCPO_PORT_TEST}
#   - web:   Web Server (REST API)         — host port ${GOFR_DIG_WEB_PORT_TEST}

name: gofr-dig-test

x-gofr-ports: &gofr_ports
  env_file:
    - ../lib/gofr-common/config/gofr_ports.env

# Shared settings for all gofr-dig application services
x-gofr-dig-common: &gofr_dig_common
  <<: *gofr_ports
  image: gofr-dig-prod:latest
  restart: "no"
  networks:
    - gofr-test-net

services:
  # ==========================================================================
  # 0a. Vault (Ephemeral Dev Mode)
  # ==========================================================================
  vault:
    image: hashicorp/vault:1.15.4
    container_name: gofr-vault-test
    hostname: gofr-vault-test
    restart: "no"
    cap_add:
      - IPC_LOCK
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=gofr-dev-root-token
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_LOG_LEVEL=warn
      - VAULT_ADDR=http://127.0.0.1:8200
    command: server -dev
    ports:
      - "${GOFR_VAULT_PORT_TEST:-8301}:8200"
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 2s
      timeout: 3s
      retries: 15
      start_period: 5s
    networks:
      - gofr-test-net

  # ==========================================================================
  # 0b. Vault Init (Seed Secrets -- runs once then exits)
  # ==========================================================================
  vault-init:
    image: hashicorp/vault:1.15.4
    container_name: gofr-vault-init-test
    restart: "no"
    depends_on:
      vault:
        condition: service_healthy
    environment:
      - VAULT_ADDR=http://gofr-vault-test:8200
      - VAULT_TOKEN=gofr-dev-root-token
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Seeding test secrets into Vault..."
        vault kv put secret/gofr/config/jwt-signing-secret \
          value="test-secret-key-for-secure-testing-do-not-use-in-production"
        echo "Vault secrets seeded successfully."
    networks:
      - gofr-test-net

  # ==========================================================================
  # 1. MCP Server (Core Logic)
  # ==========================================================================
  mcp:
    <<: *gofr_dig_common
    container_name: gofr-dig-mcp-test
    hostname: gofr-dig-mcp-test
    user: root
    working_dir: /home/gofr-dig
    entrypoint: ["/bin/sh", "-c"]
    depends_on:
      vault-init:
        condition: service_completed_successfully
    command:
      - |
        mkdir -p /home/gofr-dig/data/storage /home/gofr-dig/data/auth /home/gofr-dig/logs
        chown -R gofr-dig:gofr-dig /home/gofr-dig/data /home/gofr-dig/logs
        # VaultIdentity/AppRole is optional in the dev stack. By default we use
        # token-based Vault auth via GOFR_DIG_VAULT_TOKEN.
        if [ "$${GOFR_DIG_USE_VAULT_IDENTITY:-0}" = "1" ]; then
          mkdir -p /run/secrets
          cp /run/gofr-secrets/service_creds/gofr-dig.json /run/secrets/vault_creds
          chown gofr-dig:gofr-dig /run/secrets/vault_creds
        fi
        if [ "$${GOFR_DIG_NO_AUTH:-0}" = "1" ]; then
          NOAUTH="--no-auth"
        else
          NOAUTH=""
        fi
        exec su -s /bin/bash gofr-dig -c "/home/gofr-dig/.venv/bin/python -m app.main_mcp --host 0.0.0.0 --port $${GOFR_DIG_MCP_PORT} $$NOAUTH"
    environment:
      - GOFR_DIG_ENV=TEST
      - GOFR_DIG_MCP_PORT=${GOFR_DIG_MCP_PORT}
      - GOFR_DIG_LOG_LEVEL=${GOFR_DIG_LOG_LEVEL:-DEBUG}
      - GOFR_DIG_DATA_DIR=/home/gofr-dig/data
      - GOFR_DIG_STORAGE_DIR=/home/gofr-dig/data/storage
      - GOFR_DIG_ALLOW_PRIVATE_URLS=${GOFR_DIG_ALLOW_PRIVATE_URLS:-false}
      - GOFR_DIG_RATE_LIMIT_CALLS=${GOFR_DIG_RATE_LIMIT_CALLS:-60}
      - GOFR_DIG_RATE_LIMIT_WINDOW=${GOFR_DIG_RATE_LIMIT_WINDOW:-60}
      - GOFR_DIG_NO_AUTH=${GOFR_DIG_NO_AUTH:-0}
      - GOFR_DIG_USE_VAULT_IDENTITY=${GOFR_DIG_USE_VAULT_IDENTITY:-0}
      # Auth backend (vault only)
      - GOFR_DIG_AUTH_BACKEND=vault
      - GOFR_DIG_VAULT_URL=http://gofr-vault-test:8200
      - GOFR_DIG_VAULT_TOKEN=gofr-dev-root-token
      - GOFR_DIG_VAULT_PATH_PREFIX=${GOFR_DIG_VAULT_PATH_PREFIX:-gofr/auth}
      - GOFR_DIG_VAULT_MOUNT=${GOFR_DIG_VAULT_MOUNT:-secret}
    ports:
      - "${GOFR_DIG_MCP_HOST_PORT:-${GOFR_DIG_MCP_PORT_TEST}}:${GOFR_DIG_MCP_PORT}"
    volumes:
      - sessions-data:/home/gofr-dig/data/storage/sessions
      - gofr-secrets-test:/run/gofr-secrets:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:${GOFR_DIG_MCP_PORT}/mcp || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ==========================================================================
  # 2. MCPO Server (OpenAPI Wrapper)
  # ==========================================================================
  mcpo:
    <<: *gofr_dig_common
    container_name: gofr-dig-mcpo-test
    hostname: gofr-dig-mcpo-test
    user: gofr-dig
    working_dir: /home/gofr-dig
    entrypoint: []
    depends_on:
      mcp:
        condition: service_healthy
    command: >
      /home/gofr-dig/.venv/bin/mcpo
      --host 0.0.0.0 --port ${GOFR_DIG_MCPO_PORT} --server-type streamable-http
      -- http://gofr-dig-mcp-test:${GOFR_DIG_MCP_PORT}/mcp
    environment:
      - GOFR_DIG_ENV=TEST
      - GOFR_DIG_MCP_PORT=${GOFR_DIG_MCP_PORT}
      - GOFR_DIG_MCPO_PORT=${GOFR_DIG_MCPO_PORT}
    ports:
      - "${GOFR_DIG_MCPO_HOST_PORT:-${GOFR_DIG_MCPO_PORT_TEST}}:${GOFR_DIG_MCPO_PORT}"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:${GOFR_DIG_MCPO_PORT}/openapi.json || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ==========================================================================
  # 3. Web Server (REST API)
  # ==========================================================================
  web:
    <<: *gofr_dig_common
    container_name: gofr-dig-web-test
    hostname: gofr-dig-web-test
    user: root
    working_dir: /home/gofr-dig
    entrypoint: ["/bin/sh", "-c"]
    depends_on:
      vault-init:
        condition: service_completed_successfully
    command:
      - |
        mkdir -p /home/gofr-dig/logs
        chown -R gofr-dig:gofr-dig /home/gofr-dig/logs
        # VaultIdentity/AppRole is optional in the dev stack. By default we use
        # token-based Vault auth via GOFR_DIG_VAULT_TOKEN.
        if [ "$${GOFR_DIG_USE_VAULT_IDENTITY:-0}" = "1" ]; then
          mkdir -p /run/secrets
          cp /run/gofr-secrets/service_creds/gofr-dig.json /run/secrets/vault_creds
          chown gofr-dig:gofr-dig /run/secrets/vault_creds
        fi
        if [ "$${GOFR_DIG_NO_AUTH:-0}" = "1" ]; then
          NOAUTH="--no-auth"
        else
          NOAUTH=""
        fi
        exec su -s /bin/bash gofr-dig -c "/home/gofr-dig/.venv/bin/python -m app.main_web --host 0.0.0.0 --port $${GOFR_DIG_WEB_PORT} $$NOAUTH"
    environment:
      - GOFR_DIG_ENV=TEST
      - GOFR_DIG_WEB_PORT=${GOFR_DIG_WEB_PORT}
      - GOFR_DIG_LOG_LEVEL=${GOFR_DIG_LOG_LEVEL:-DEBUG}
      - GOFR_DIG_DATA_DIR=/home/gofr-dig/data
      - GOFR_DIG_STORAGE_DIR=/home/gofr-dig/data/storage
      - GOFR_DIG_NO_AUTH=${GOFR_DIG_NO_AUTH:-0}
      - GOFR_DIG_USE_VAULT_IDENTITY=${GOFR_DIG_USE_VAULT_IDENTITY:-0}
      # Auth backend (vault only)
      - GOFR_DIG_AUTH_BACKEND=vault
      - GOFR_DIG_VAULT_URL=http://gofr-vault-test:8200
      - GOFR_DIG_VAULT_TOKEN=gofr-dev-root-token
      - GOFR_DIG_VAULT_PATH_PREFIX=${GOFR_DIG_VAULT_PATH_PREFIX:-gofr/auth}
      - GOFR_DIG_VAULT_MOUNT=${GOFR_DIG_VAULT_MOUNT:-secret}
    ports:
      - "${GOFR_DIG_WEB_HOST_PORT:-${GOFR_DIG_WEB_PORT_TEST}}:${GOFR_DIG_WEB_PORT}"
    volumes:
      - sessions-data:/home/gofr-dig/data/storage/sessions
      - gofr-secrets-test:/run/gofr-secrets:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:${GOFR_DIG_WEB_PORT}/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

# ==========================================================================
# Networks — Test Network (isolated from production)
# ==========================================================================
networks:
  gofr-test-net:
    name: gofr-test-net
    external: true
    # Create manually if needed: docker network create gofr-test-net

# ==========================================================================
# Volumes — Shared ephemeral storage for cross-service session access
# ==========================================================================
volumes:
  sessions-data:
    # Ephemeral — destroyed with 'docker compose down -v'
  gofr-secrets-test:
    name: gofr-secrets-test
    external: true
    # Test-only secrets volume — isolated from production gofr-secrets
